#!/bin/bash
#
# Pre-commit hook to sync Sigma rules to workshop_manual.md
#
# This hook runs automatically before each commit to ensure the
# workshop manual stays in sync with the individual rule files.

echo "Syncing Sigma rules to workshop_manual.md..."

# Get the repo root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Run the sync script (try py launcher first for Windows compatibility)
if command -v py &> /dev/null; then
    py "$REPO_ROOT/scripts/sync_rules.py"
elif command -v python3 &> /dev/null; then
    python3 "$REPO_ROOT/scripts/sync_rules.py"
elif command -v python &> /dev/null; then
    python "$REPO_ROOT/scripts/sync_rules.py"
else
    echo "Error: Python not found. Please ensure Python is installed and in PATH."
    exit 1
fi

if [ $? -ne 0 ]; then
    echo "Error: Rule sync failed. Please check the output above."
    exit 1
fi

# Stage the updated manual if it changed
if git diff --quiet "$REPO_ROOT/workshop_manual.md" 2>/dev/null; then
    echo "No changes to workshop_manual.md"
else
    echo "Staging updated workshop_manual.md..."
    git add "$REPO_ROOT/workshop_manual.md"
fi

echo "Pre-commit sync complete!"
